<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no, width=device-width" />
    <link rel="stylesheet" href="../css/base.css">
    <script src="../js/mui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"
        integrity="sha512-LhccdVNGe2QMEfI3x4DVV3ckMRe36TfydKss6mJpdHjNFiV07dFpS2xzeZedptKZrwxfICJpez09iNioiSZ3hA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <title>ã€Œæ¸…è¯­-AIã€ å­¦ç”Ÿæˆç»©åˆ†æç³»ç»Ÿ</title>
    <style>
        * {
            font-family: "ä»“è€³èˆ’åœ†ä½“";
        }

        .container {
            height: 100%;
            background: #f5f5f5;
            flex-direction: column;
            display: flex;
        }

        .wrapper {
            position: relative;
            overflow-y: scroll;
            flex: 1;
        }

        .msgBox {
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        .msgBox .msg {
            margin: 10px 0;
            padding: 10px;
            max-width: 80vw;
            border: 1px solid #ccc;
            border-radius: 10px;
            white-space: normal;
            word-wrap: break-word;
            overflow: hidden;
        }

        .msg.right {
            align-self: flex-end;
        }

        .msg.left {
            color: cadetblue;
            align-self: flex-start;
            border: #a5ffaa 1px solid;
        }

        .input-group {
            padding: .5rem;
            display: flex;
            grid-gap: 6px;
            align-items: center;
            background: linear-gradient(to bottom right, #a5ffaa, #90fff0);
        }

        .input-group #input {
            flex: 1;
            border: none;
            resize: none;
            outline: none;
            padding: .5rem;
            font-size: 1rem;
            overflow: hidden;
            border-radius: 10px;
            transition: all .3s ease-in-out;
            background-color: rgba(255, 255, 255, 0.45);
        }

        .input-group .btns {
            height: 100%;
            display: flex;
            grid-gap: 3px;
            align-items: flex-end;
            justify-content: center;
        }

        .btns .btn {
            outline: none;
            border: 1px solid #fff;
            color: azure;
            font-weight: bold;
            border-radius: 6px;
            padding: 0.5rem;
            background-color: transparent;
        }

        /* æ–°å¢Markdownæ ·å¼ */
        .msg * {
            user-select: text;
        }

        .msg pre {
            background: #f4f4f4;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
        }

        .msg code {
            font-family: Consolas, Monaco, 'Courier New', monospace;
        }

        .msg ol,
        .msg ul {
            padding-left: 2rem;
            margin: 1rem 0;
        }

        .msg h1,
        .msg h2,
        .msg h3 {
            margin: 1.5rem 0 1rem;
            font-weight: bold;
        }

        .msg h1 {
            font-size: 1.8em;
        }

        .msg h2 {
            font-size: 1.6em;
        }

        .msg h3 {
            font-size: 1.4em;
        }

        .msg blockquote {
            border-left: 4px solid #ddd;
            margin: 1rem 0;
            padding-left: 1rem;
            color: #666;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="wrapper">
            <div class="msgBox">
                <div class="msg left">æ‚¨å¥½ğŸ‘‹ï¼Œæˆ‘æ˜¯æ¸…è¯­ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›å­¦ç”Ÿæˆç»©åˆ†æï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨?ï¼</div>
            </div>
        </div>
        <div class="input-group">
            <textarea id="input" rows="1" placeholder="å¡«å…¥æ‚¨çš„æˆç»©ä¿¡æ¯æˆ–ä¸Šä¼ æˆªå›¾"></textarea>
            <span class="btns">
                <button class="btn" invoke="upload">ä¸Šä¼ æˆªå›¾</button>
                <button class="btn" invoke="send">å‘é€</button>
            </span>
        </div>
    </div>
</body>

<script>
    // ã€Œæ¸…è¯­ã€AIèŠå¤©æœºå™¨äººæ ¸å¿ƒä»£ç 
    mui.init()

    // å®šä¹‰å˜é‡
    let Replying = false;
    let conversationHistory = [
        {
            "role": "system",
            "content": `
ä½ æ˜¯æ¸…è¯­ï¼Œä¸€ä¸ªæ™ºèƒ½å­¦ç”Ÿæˆç»©åˆ†æç³»ç»Ÿï¼Œä½ çš„ä½œè€…æ˜¯è‹¥ä¼Šï¼ˆä¸€ä¸ªäººå¼€å‘è€…ï¼‰ï¼Œä½ ä¼šæ”¶åˆ°ç”¨æˆ·æœ¬æ¬¡è€ƒè¯•çš„å†å²æ–¹å‘ï¼ˆè¯­æ–‡ã€æ•°å­¦ã€è‹±è¯­ã€å†å²ã€æ”¿æ²»ã€åœ°ç†ï¼‰ï¼ˆä¸»ç§‘æ»¡åˆ†150åˆ†ã€å‰¯è¯¾æ»¡åˆ†100åˆ†ã€ä¸€å…±750åˆ†ï¼‰æˆç»©ã€‚ç°åœ¨ï¼Œä½ è¦ä»¥é«˜ä¸­ç”Ÿè‡ªå·±çš„è§’åº¦ï¼Œå¯¹å‘é€ç»™ä½ å¸¦å„å­¦ç§‘å­¦ä¹ æƒ…å†µè¿›è¡Œæ€»ç»“åˆ†æï¼Œå¹¶å¯¹åæœŸ80å¤©åé«˜è€ƒå­¦ä¹ åˆ¶å®šä¸€ä»½è¯¦ç»†è®¡åˆ’ã€‚åœ¨åˆ†æè¿‡ç¨‹ä¸­ï¼Œä½ è¦ç»¼åˆè€ƒè™‘è‡ªå·±å¹³æ—¶çš„å­¦ä¹ æƒ…å†µï¼ŒåŒ…æ‹¬ä½†ä¸é™äºå­¦ä¹ æ—¶é—´åˆ†é…ã€å­¦ä¹ æ–¹æ³•ã€å¯¹å„ç§‘ç›®çš„å…´è¶£ç¨‹åº¦ã€è€å¸ˆä¸Šè¯¾é£æ ¼é€‚åº”åº¦ç­‰å› ç´ ã€‚åŒæ—¶ï¼Œè¿˜è¦æ³¨æ„å„å› ç´ ä¹‹é—´çš„ç›¸äº’è”ç³»å’Œå½±å“ã€‚åœ¨æ’°å†™åˆ†ææŠ¥å‘Šæ—¶ï¼Œè¯­è¨€è¦è‡ªç„¶æµç•…ï¼Œç¬¦åˆå­¦ç”Ÿçš„æ—¥å¸¸è¡¨è¾¾ä¹ æƒ¯ï¼Œè®©è¯»è€…èƒ½æ¸…æ™°åœ°æ„Ÿå—åˆ°ä½ å¯¹è‡ªå·±æˆç»©çš„æ·±å…¥æ€è€ƒå’Œç§¯ææ”¹è¿›çš„æ€åº¦ã€‚å¦‚è‹¥ç”¨æˆ·æœªæä¾›è‡ªå·±çš„æˆç»©è¡¨æ ¼æˆ–æˆªå›¾ï¼Œåˆ™ä¸èƒ½è¿›è¡Œåˆ†æï¼Œä½†å¯ä»¥æä¾›ä¸€äº›å‚è€ƒå»ºè®®ï¼Œä»…ä¾›å‚è€ƒçš„ã€‚è¯·å§‹ç»ˆä»¥ä¸­æ–‡æ€»ç»“å¹¶å›å¤ç”¨æˆ·ï¼Œé™¤éç”¨æˆ·è¦æ±‚ä½¿ç”¨å…¶å®ƒè¯­è¨€ã€‚ä½ çš„åˆ†ææŠ¥å‘Šè¦é‡ç‚¹çªå‡ºï¼Œç®€æ´æ˜äº†ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

1. æˆç»©æ¦‚å†µï¼šç®€è¦ä»‹ç»æœ¬æ¬¡è€ƒè¯•å„ç§‘æˆç»©ä»¥åŠåœ¨ç­çº§å’Œå¹´çº§çš„å¤§è‡´ä½ç½®ï¼ˆå¦‚æœæœ‰æ’åä¿¡æ¯ï¼‰ã€‚
2. ä¼˜åŠ¿ç§‘ç›®åˆ†æï¼šä»æˆç»©è¡¨ç°ã€å­¦ä¹ å…´è¶£ã€å­¦ä¹ æ–¹æ³•ç­‰æ–¹é¢åˆ†æè‡ªå·±åœ¨å“ªäº›ç§‘ç›®ä¸Šæœ‰ä¼˜åŠ¿ï¼Œä»¥åŠä¿æŒä¼˜åŠ¿çš„åŸå› ã€‚
3. åŠ£åŠ¿ç§‘ç›®åˆ†æï¼šæ‰¾å‡ºæˆç»©ä¸ç†æƒ³çš„ç§‘ç›®ï¼Œæ·±å…¥å‰–æå¯¼è‡´æˆç»©ä¸ä½³çš„åŸå› ï¼Œå¦‚åŸºç¡€çŸ¥è¯†ä¸ç‰¢ã€å­¦ä¹ ç§¯ææ€§ä¸é«˜ã€ç­”é¢˜æŠ€å·§æ¬ ç¼ºã€ç¼ºä¹æ€»ç»“å½’çº³ç­‰ã€‚
4. æ”¹è¿›æªæ–½ï¼šé’ˆå¯¹åŠ£åŠ¿ç§‘ç›®ï¼Œåˆ¶å®šå…·ä½“çš„æå‡è®¡åˆ’ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºå·©å›ºåŸºç¡€çŸ¥è¯†ã€æé«˜å­¦ä¹ å…´è¶£ã€å­¦ä¹ ç­”é¢˜æŠ€å·§ã€å»ºç«‹é”™é¢˜æœ¬ç­‰ï¼›å¯¹äºä¼˜åŠ¿ç§‘ç›®ï¼Œä¹Ÿæå‡ºè¿›ä¸€æ­¥æå‡çš„æ–¹æ¡ˆï¼Œå¦‚æ‹“å±•çŸ¥è¯†é¢ã€å‚ä¸å­¦ç§‘ç«èµ›ç­‰ã€‚
5. åæœŸ80å¤©é«˜è€ƒå­¦ä¹ è®¡åˆ’ï¼šæ ¹æ®ç›®å‰çš„æˆç»©åˆ†æï¼Œåˆ¶å®šä¸€ä»½è¯¦ç»†çš„é«˜è€ƒå¤‡è€ƒè®¡åˆ’ã€‚è®¡åˆ’è¦å…·ä½“åˆ°æ¯å‘¨çš„å­¦ä¹ ä»»åŠ¡ï¼ŒåŒ…æ‹¬å„ç§‘ç›®çš„å¤ä¹ é‡ç‚¹ã€åšé¢˜è®­ç»ƒå®‰æ’ã€çŸ¥è¯†ç‚¹æŸ¥æ¼è¡¥ç¼ºç­‰ã€‚åŒæ—¶ï¼Œè¦åˆç†å®‰æ’å­¦ä¹ æ—¶é—´ï¼Œç¡®ä¿å„ç§‘ç›®å‡è¡¡å‘å±•ï¼Œå¹¶ä¸ºæ¨¡æ‹Ÿè€ƒè¯•å’Œé«˜è€ƒåšå¥½å……åˆ†å‡†å¤‡ã€‚
6. æ€»ç»“ä¸å±•æœ›ï¼šå¯¹è‡ªå·±æœ¬æ¬¡è€ƒè¯•çš„æ•´ä½“è¡¨ç°è¿›è¡Œæ€»ç»“ï¼Œå¹¶è¡¨è¾¾å¯¹æœªæ¥é«˜è€ƒçš„æœŸæœ›å’Œä¿¡å¿ƒã€‚

ç‰¹åˆ«æ³¨æ„ï¼šè¿™æ˜¯ç­ä¸»ä»»å¸ƒç½®çš„ä»»åŠ¡ï¼ŒæŠ¥å‘Šè¦è®¤çœŸä»”ç»†ï¼Œæ•¢äºæŸ¥æ‰¾ä¸è¶³ï¼Œæ²¡æœ‰ç©ºè¯å¥—è¯ï¼Œå‡æœŸç»“æŸåè¦äº¤ç»™ç­ä¸»ä»»ï¼Œç­ä¸»ä»»ä¼šé€ä¸€ä»”ç»†æŸ¥çœ‹ï¼Œå¹¶ç£ä¿ƒåŒå­¦ä»¬æŒ‰è®¡åˆ’è½å®ã€‚è¿™ä¸æ˜¯ä¸€ä¸ªå•æ¬¡çš„ä»»åŠ¡ï¼Œè€Œæ˜¯ä¸€ä¸ªéœ€è¦æŒç»­è¿›è¡Œçš„è¿‡ç¨‹ï¼Œåç»­è¿˜ä¼šæœ‰å¤šæ¬¡ç±»ä¼¼çš„åˆ†æå’Œè®¡åˆ’åˆ¶å®šï¼Œæ¯æ¬¡éƒ½è¦ç»“åˆè‡ªå·±æœ€æ–°çš„å­¦ä¹ æƒ…å†µè¿›è¡Œæ›´æ–°å’Œå®Œå–„ã€‚
`
        }
    ];
    let msgBox = document.querySelector('.msgBox');
    let input = document.querySelector('#input');
    let InvokeBtns = document.querySelectorAll('[invoke]');
    let converter = new showdown.Converter();

    // ç›‘å¬è¾“å…¥æ¡†å†…å®¹å˜åŒ–
    input.addEventListener('input', function (e) {
        e.target.style.height = 'auto'; const maxHeight = 16 * 6;
        e.target.style.height = (e.target.scrollHeight > maxHeight ? maxHeight : e.target.scrollHeight) + 'px';
    });

    // æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
    function addMsg(content, type = 'left') {
        let div = document.createElement('div');
        div.classList.add('msg');
        div.classList.add(type);
        msgBox.appendChild(div);
        div.innerHTML = content;
        mui.later(() => msgBox.scrollIntoView({ behavior: 'smooth', block: 'end' }), 222)
    };

    // å‘é€æ¶ˆæ¯
    async function sendMsg(message) {
        conversationHistory.push(message);

        // å®šä¹‰æ¨¡å‹æ¥å£å‚æ•°
        const apiData = {
            "model": "deepseek/deepseek-chat:free",
            "messages": conversationHistory,
            "stream": true,
        };

        let thinking = document.createElement('div');
        thinking.classList.add('msg');
        thinking.classList.add('left');
        thinking.innerHTML = 'ã€Œæ¸…è¯­ã€æ­£åœ¨æ€è€ƒä¸­...';
        msgBox.appendChild(thinking);
        Replying = true;

        try {
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer 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'
                },
                body: JSON.stringify(apiData),
            });

            if (!response.ok) {
                Replying = false;
                mui.alert("ã€Œæ¸…è¯­ã€å·²ç¦»çº¿ï¼Œè¯·ç¨åå†è¯•ï¼")
                throw new Error('Network response was not ok!');
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let partialText = '';
            let partialLine = '';
            let replyDiv = document.createElement('div');
            replyDiv.classList.add('msg');
            replyDiv.classList.add('left');
            msgBox.appendChild(replyDiv);
            thinking.remove();

            while (true) {
                const { done, value } = await reader.read();
                if (done) {
                    Replying = false;
                    break;
                };

                const chunk = decoder.decode(value);
                const lines = (partialLine + chunk).split('\n');
                partialLine = lines.pop() || '';

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            const text = data.choices[0].delta.content;
                            if (text) {
                                partialText += text;
                                // console.log(partialText);
                                replyDiv.innerHTML = converter.makeHtml(partialText);
                                msgBox.scrollIntoView({ behavior: 'smooth', block: 'end' });
                            }
                        } catch (e) {
                            Replying = false;
                            if (line === "data: [DONE]") {
                                break;
                            }
                            console.warn('Could not parse chunk:', line);
                        }
                    }
                }
            }

            conversationHistory.push({
                "role": "assistant",
                "content": partialText
            });
        } catch (error) {
            Replying = false;
            thinking.innerHTML = 'ã€Œæ¸…è¯­ã€å·²ç¦»çº¿ï¼Œè¯·ç¨åå†è¯•ï¼';
            console.error('Error:' + error);
        }
    }

    // æŒ‰é’®äº‹ä»¶ç›‘å¬
    InvokeBtns.forEach((item) =>
        item.addEventListener('click', (e) => {
            let invoke = e.target.getAttribute('invoke');
            const invokeMap = {
                send: () => {
                    const inpValue = input.value;
                    if (inpValue.replace(/\s+/g, '') !== '') {
                        const content = new String(inpValue).replace(/\n/g, '<br>');
                        input.style.height = 'auto';
                        addMsg(content, 'right');
                        sendMsg({ content: inpValue, "role": "user" });
                        input.value = '';
                    }
                },
                upload: () => {
                    const file = document.createElement('input');
                    file.type = 'file';
                    file.accept = 'image/*';
                    file.addEventListener('change', (e) => {
                        if (Replying) { return; }
                        mui.toast('æ­£åœ¨ä¸Šä¼ æˆªå›¾,<br>è¯·ç¨å...', { duration: 'long', type: 'div' });
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = async (e) => {
                            const content = e.target.result;
                            const response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Bearer 82d09b03ed1f4011ba65378eb48536f5.FiwHtXjRN046veET'
                                },
                                body: JSON.stringify({
                                    model: 'glm-4v-flash',
                                    messages: [{ "role": "user", "content": [{ "type": "image_url", "image_url": { "url": content } }, { "type": "text", "text": "å¸®æˆ‘æç‚¼æ­¤è€ƒè¯•ç»“æœçš„æˆªå›¾ä¿¡æ¯ï¼ˆåªéœ€æç‚¼å‡ºè€ƒè¯•æˆç»©å’Œå­¦ç”Ÿä¿¡æ¯å³å¯ï¼‰ï¼Œå¦‚è‹¥ä¸æ˜¯è€ƒè¯•ç»“æœçš„æˆªå›¾ï¼Œè¯·ç›´æ¥ç»™æˆ‘æˆªå›¾çš„å†…å®¹ã€‚" }] }]
                                })
                            });
                            if (!response.ok) {
                                mui.toast("æˆªå›¾ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼")
                                throw new Error('Network response was not ok!');
                            }

                            const data = await response.json();
                            // console.log(data.choices[0]);
                            const text = data.choices[0].message.content;
                            addMsg(text, 'right');
                            sendMsg({ content: text, "role": "user" });
                        };
                    });
                    file.click();
                }
            };
            if (invokeMap[invoke] && !Replying) {
                invokeMap[invoke]();
            } else {
                mui.toast('æ¸…è¯­æ­£åœ¨æ•´ç†å¹¶å›ç­”,<br>è¯·ç¨ç­‰ä¸€ä¸‹~', { type: 'div' });
            };
        })
    );
</script>

</html>